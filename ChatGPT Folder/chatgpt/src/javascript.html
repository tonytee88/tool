<script>




window.addEventListener('load', function() {
  console.log('Page is loaded');
});

var optionsCount = 1;
const optionsTotal = 3;
var globalApiResponse = {
  "email subject line": {
    "option1": "Ride in style with our Bike Flash Sale!",
    "option2": "Unbeatable deals on bikes this week only!",
    "option3": "Get ready to bike your heart out with our Flash Sale!",
    "option4": "Bike enthusiasts rejoice! Our Flash Sale is here!",
    "option5": "Find your perfect ride at our Bike Flash Sale!"
  },
  "email preview text": {
    "option1": "Don't miss out on the bike sale event of the year!",
    "option2": "Get your hands on the finest bikes at the most amazing prices!",
    "option3": "Upgrade your ride at our epic Flash Sale! Hurry, limited time only!",
    "option4": "Be the first to grab the deal of a lifetime on your dream bike!",
    "option5": "Join the Flash Sale frenzy and save big on bikes!"
  }
};

  // const loginForm = document.getElementById("loginForm");

  // loginForm.addEventListener("submit", (e) => {
  //   e.preventDefault();
    
  //   // Get the status message element
  //   var statusMessage = document.getElementById("statusMessage");
  //   // Set the message to indicate the running state
  //   statusMessage.textContent = "Grabbing all the {tags}...";

  //   let subject = document.getElementById("subject");
  //   let lang = document.getElementById("lang");
  //   console.log("ok for steps to get " + subject.value + " and " + lang.value);

  //   new Promise((resolve, reject) => {
  //   google.script.run.withSuccessHandler(resolve).getPromptElements();
  // }).then((promptElements) => {

  //     //console.log("Prompt Elements :" + promptElements)

  //     statusMessage.textContent = "Talking to ChatGPT...";

  //     return new Promise((resolve, reject) => {
  
  //     google.script.run
  //     .withSuccessHandler((result) => {
  //       console.log("Success:", result);
  //       resolve(result);
  //     }).withFailureHandler((error) => {
  //       console.log("Error:", error);
  //       reject(error);
  //     }).getAIReponse(subject.value,promptElements);
  //   });
  // }).then(() => {
  //     statusMessage.textContent = "Script completed.";
  //     }).catch((error) => {
  //       // Handle any errors that occur during script execution
  //       console.error(error);
  //       statusMessage.textContent = "Script encountered an error.";
  //     });
  // });

function loadTags() {
  google.script.run.withSuccessHandler(processTags).getTags();
}

function processTags(tags) {
  var tagList = document.getElementById('tagList');
  tagList.innerHTML = ''; // Clear existing content

  // Create the tag list table
  var table = document.createElement('table');
  table.id = 'mainTable';

  // Iterate over each tag and create table rows
  tags.forEach(function (tag) {
    // Create unique IDs for buttons and tagsWithDelimitersCell
    var buttonId = 'button_' + tag.replace(/\s+/g, '-').replace('{', '').replace('}', '');
    var tagsWithDelimitersCellId = 'tagsCell_' + tag.replace(/\s+/g, '-').replace('{', '').replace('}', '');
    
    // Create the first row
    var firstRow = document.createElement('tr');

    // Create the cells for the first row
    var emptyCell = document.createElement('td');
    var tagsWithoutDelimitersCell = document.createElement('td');
    tagsWithoutDelimitersCell.textContent = tag.replace('{', '').replace('}', '');
    tagsWithoutDelimitersCell.className = 'title-content-cell';
  
    // Append the cells to the first row
    firstRow.appendChild(emptyCell);
    firstRow.appendChild(tagsWithoutDelimitersCell);

    // Create the second row
    var secondRow = document.createElement('tr');

    // Create the cells for the second row
    var buttonCell = document.createElement('td');
    var tagsWithDelimitersCell = document.createElement('td');
    tagsWithDelimitersCell.textContent = tag;
    tagsWithDelimitersCell.className = 'text-content-cell ';
    tagsWithDelimitersCell.id = tag.replace(/\s+/g, '-').replace('{', '').replace('}', '');
    tagsWithDelimitersCell.setAttribute('data-state', 'unlocked');


    // Set the initial data-option attribute
    tagsWithDelimitersCell.setAttribute('data-option', '1');
    // Create button container
    var buttonContainer = document.createElement('div');
    buttonContainer.className = 'button-container';
    buttonCell.appendChild(buttonContainer);

    // Create the options hover-over element
    var optionsHover = document.createElement('div');
    optionsHover.className = 'options-hover';
    optionsHover.id = 'optionsHover_' + tag.replace(/\s+/g, '-').replace('{', '').replace('}', '');
    optionsHover.textContent = "Options: "

    // Attach the hover-over element to the optionsHoverBottom element
    var optionsHoverBottom = document.getElementById('optionsHoverBottom');
    optionsHoverBottom.appendChild(optionsHover);

    // Add event listeners for hover events
    buttonCell.addEventListener('mouseenter', function () {
    var optionsHoverId = 'optionsHover_' + tag.replace(/\s+/g, '-').replace('{', '').replace('}', '');
    var optionsHover = document.getElementById(optionsHoverId);
    optionsHover.style.display = 'block';
    bottomContainer.style.display = 'block';
    });

    buttonCell.addEventListener('mouseleave', function () {
    var optionsHoverId = 'optionsHover_' + tag.replace(/\s+/g, '-').replace('{', '').replace('}', '');
    var optionsHover = document.getElementById(optionsHoverId);
    optionsHover.style.display = 'none';
    bottomContainer.style.display = 'none';
    });

    // Create the button elements with unique IDs
    var backButton = document.createElement('button');
    backButton.textContent = '◄';
    backButton.className = 'back-button';
    backButton.style.border = 'none';
    backButton.id = buttonId; // Set the unique ID

    var nextButton = document.createElement('button');
    nextButton.textContent = '►';
    nextButton.className = 'next-button';
    nextButton.style.border = 'none';
    nextButton.id = buttonId + '_next'; // Set the unique ID

    // Append the button to the button cell
    buttonContainer.appendChild(backButton);
    buttonContainer.appendChild(nextButton);

    // Append the rows to the table
    table.appendChild(firstRow);
    table.appendChild(secondRow);

    // Append the cells to the second row
    secondRow.appendChild(buttonCell);
    secondRow.appendChild(tagsWithDelimitersCell);
  

    // Apply border styles to cells
    emptyCell.style.border = 'none'; // No border for the empty cell
    tagsWithoutDelimitersCell.style.border = 'none'; // No border for the cell spanning both columns
    buttonCell.style.border = 'none'; // No border for the button cell
    tagsWithDelimitersCell.style.border = '2px solid #000'; // Thick border for the second cell of the second row
    
    // Add the click event listener to the "Back" button
    backButton.addEventListener('click', function() {
      var buttonId = this.id;
      var tagsWithDelimitersCellId = buttonId.replace('button_', ''); // Remove the 'button_' prefix
      var tagsWithDelimitersCell = document.getElementById(tagsWithDelimitersCellId);
      var test183 = parseInt(tagsWithDelimitersCell.getAttribute('data-option'));
      console.log("test183: " + test183);
      
      showPreviousOption(tagsWithDelimitersCell, tagsWithDelimitersCellId);
    });

    // Add the click event listener to the "Next" button
    nextButton.addEventListener('click', function() {
      var buttonId = this.id;
      var tagsWithDelimitersCellId = buttonId.replace('button_', ''); // Remove the 'button_' prefix
      tagsWithDelimitersCellId = tagsWithDelimitersCellId.replace('_next', ''); // Remove the '_next' suffix
      var tagsWithDelimitersCell = document.getElementById(tagsWithDelimitersCellId);
      console.log("name: " + tagsWithDelimitersCellId);
      showNextOption(tagsWithDelimitersCell, tagsWithDelimitersCellId);
    });
    backButton.addEventListener('click', function() {
    backButton.classList.add('clicked');
    setTimeout(function() {
      backButton.classList.remove('clicked');
    }, 500);
    // Rest of your code...
  });

  nextButton.addEventListener('click', function() {
    nextButton.classList.add('clicked');
    setTimeout(function() {
      nextButton.classList.remove('clicked');
    }, 500);
    // Rest of your code...
  });


  });

   

  
  // Append the table to the tag list element
  tagList.appendChild(table);

  //end of table generating code
  
 

  // const handleRefreshButtonClick = document.getElementById("refresh");

  // refresh.addEventListener("click", (e) => {
  //   e.preventDefault();
  //   optionsCount++;
  //   console.log(optionsCount);
  //   console.log(globalApiResponse);
  //   (function handleRefreshButtonClick() {
  //   var textContentCells = document.getElementsByClassName("text-content-cell");
  //   var titleContentCells = document.getElementsByClassName("title-content-cell");

  //   for (var i = 0; i < textContentCells.length; i++) {
  //     var cell = textContentCells[i];
  //     var state = cell.getAttribute("data-state");
  //     var tag = cell.getAttribute("data-tag");
  //     var tagName = titleContentCells[i].textContent;
  //     var generatedCopyRefreshed = globalApiResponse[tagName]["option" + optionsCount];
  //     console.log("option" + optionsCount);
  //     console.log("generated copy for each button:"+generatedCopyRefreshed);
  //     if (state === "unlocked") { //(state === "unlocked" && tag)
  //       cell.textContent = generatedCopyRefreshed;
  //     }
  //   }
  //   })();
  //   });

    const handleUpdateButtonClick = document.getElementById("update");

    handleUpdateButtonClick.addEventListener("click", function() {
      var cells = document.getElementsByClassName("title-content-cell");
      var finalObjectResult = {};

      for (var i = 0; i < cells.length; i++) {
        var cell = cells[i];
        var cellText = cell.innerText.trim();
        var nextRow = cell.parentNode.nextElementSibling;
        var nextCell = nextRow ? nextRow.children[cell.cellIndex] : null;
        console.log("UPDATE RESULT1:", cellText, nextCell);

        if (nextCell !== null && nextCell.classList.contains("text-content-cell")) {
          var key = "{" + cellText + "}";
          var value = nextCell.innerText.trim();
          finalObjectResult[key] = value;
          console.log("UPDATE RESULT, value:", finalObjectResult[key]);
        }
    }
    // Call a function in your Code.gs file to update the document with finalObjectResult
    google. script.run.updateDocument(finalObjectResult);
  });
}


  // refresh.addEventListener("click", function () {
  // //optionsCount++;
  // if (optionsCount === optionsTotal) {
  //   refresh.textContent = "Options exceeded";
  //   refresh.disabled = true;
  // }
  // handleButtonWait("refresh");
  // });

//END OF PROCESS TAG FUNCTION
//----------------------------------------------------------------------------------------------------------------

function showOptionsOnHover(tag, optionsCount) {
  var responseForOptionsHover = globalApiResponse;

  // Check if the response is available
  if (responseForOptionsHover && responseForOptionsHover.hasOwnProperty(tag)) {

    var optionsHoverBottom = document.getElementById('optionsHoverBottom');
    var optionElementGeneratedContainer = document.getElementById('optionsHover_' + tag.replace(/\s+/g, '-').replace('{', '').replace('}', ''));
    optionsHoverBottom.appendChild(optionElementGeneratedContainer);

    //optionsHoverBottom.style.display = 'none'; // Hide the options initially
    // Loop through the options and add them to the optionsHoverBottom element
    for (var optionCount = 1; optionCount <= optionsTotal; optionCount++) {

      var optionText = optionCount + " - " + responseForOptionsHover[tag]["option" + optionCount];

      var optionElement = document.createElement('div');
      optionElement.textContent = optionText;
    
      optionElementGeneratedContainer.appendChild(optionElement);
    }

    //var contentHeight = window.getComputedStyle(optionElementGeneratedContainer).getPropertyValue("height");
    //console.log(contentHeight);
    //optionElementGeneratedContainer.style.height = contentHeight + 'px';
  }
}

function showPreviousOption(tagsWithDelimitersCell,tagsWithDelimitersCellId) {
  console.log("test297: " + globalApiResponse);
  console.log("test298: " + tagsWithDelimitersCellId);
  var optionsCount = parseInt(tagsWithDelimitersCell.getAttribute('data-option'));
  var previousOptionIndex = optionsCount === 1 ? optionsTotal : optionsCount - 1;
  var tag = tagsWithDelimitersCellId.replace(/-/g, ' ');
  var generatedCopyPrevious = globalApiResponse[tag]["option" + previousOptionIndex];
  tagsWithDelimitersCell.textContent = generatedCopyPrevious;
  tagsWithDelimitersCell.setAttribute('data-option', previousOptionIndex.toString());
}

function showNextOption(tagsWithDelimitersCell,tagsWithDelimitersCellId) {
  var optionsCount = parseInt(tagsWithDelimitersCell.getAttribute('data-option'));
  var nextOptionIndex = optionsCount === optionsTotal ? 1 : optionsCount + 1;
  var tag = tagsWithDelimitersCellId.replace(/-/g, ' ');
  var generatedCopyNext = globalApiResponse[tag]["option" + nextOptionIndex];
  tagsWithDelimitersCell.textContent = generatedCopyNext;
  tagsWithDelimitersCell.setAttribute('data-option', nextOptionIndex.toString());
}


var exampleObj = {
    "element1": {
      "option1": "generated copy1",
      "option2": "generated copy2",
      "option3": "generated copy3",
      "option4": "generated copy4",
      "option5": "generated copy5"
    }
  };

function updateTextContentCells(response, optionsCount) {

  var titleContentCells = document.getElementsByClassName("title-content-cell");
  var textContentCells = document.getElementsByClassName("text-content-cell");

  for (var i = 0; i < titleContentCells.length; i++) {
    var tag = titleContentCells[i].textContent;
    console.log("Tag:", tag);
    console.log("Response:"+response);
    console.log("titlecontentcells length: "+titleContentCells.length);
    if (response.hasOwnProperty(tag)) {
      var generatedCopy = response[tag]["option" + optionsCount];
      console.log("Generated Copy:", generatedCopy);
      textContentCells[i].textContent = generatedCopy;
    } else {
      console.log("Tag not found in response:", tag);
    }
  }

  return response;
}

const gptRequest = document.getElementById("gptRequest");

gptRequest.addEventListener("submit", (e) => {
  e.preventDefault();
  console.log("form works");

  // Get the subject in form
  function getSubject() {
    var subjectInput = document.getElementById("subject");
    var prompt = subjectInput.value;
    console.log(prompt);
    return prompt;
  }

  function getLang() {
    var langInput = document.getElementById("lang");
    var lang = langInput.value;
    console.log("Lang:", lang);
    return lang;
  }

  // Grab the prompt elements
  function getPromptElements() {
    var promptElements = [];
    var searchPattern = /\{([^}]+)\}/g;
    var inputs = document.querySelectorAll("#mainTable td.text-content-cell");

       inputs.forEach(function (input) {
      var tagText = input.textContent;
      //console.log("Tag Text:", tagText); // Log the tag text for debugging

      var matches = tagText.match(searchPattern);
      //console.log("Matches:", matches); // Log the matches for debugging

      if (matches) {
        for (var i = 0; i < matches.length; i++) {
          var tag = matches[i].replace('{', '').replace('}', '');
          //console.log("Tag:", tag); // Log each tag for debugging
          promptElements.push(tag);
        }
      }
    });
    return promptElements;
  }

  var prompt = getSubject();
    var lang = getLang();
  var promptElements = getPromptElements();
 

  // Make the API call
  var statusMessage = document.getElementById("statusMessage");
  // Set the message to indicate the running state
  statusMessage.textContent = "Talking to ChatGPT...";

  console.log("ok prompt: " + prompt + " and ok prompt elements: " + promptElements) + "and ok lang: " + lang;

  new Promise((resolve, reject) => {
  google.script.run
    .withSuccessHandler((result) => {
      console.log("Success:", result);
      globalApiResponse = result;
      resolve(result);
    })
    .withFailureHandler((error) => {
      console.log("Error:", error);
      reject(error);
    })
    .getGPTResponse(prompt, promptElements, optionsTotal, lang);
})
  .then((result) => {
    statusMessage.textContent = "Translating with ChatGPT...";
    if (lang === "English") {
      // Skip requestTranslation and continue to the next step
      return Promise.resolve(result);
    } else {
      // Proceed with requestTranslation
      return new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler((result) => {
            console.log("Success:", result);
            globalApiResponse = result;
            resolve(result);
          })
          .withFailureHandler((error) => {
            console.log("Error:", error);
            reject(error);
          })
          .requestTranslation(result, lang);
      });
    }
  })
  .then((result) => {
    statusMessage.textContent = "Negociation with Open AI servers...";
    console.log("Response:", result);
    // Handle the API response
    return new Promise((resolve, reject) => {
      updateTextContentCells(result, optionsCount);
      resolve(result);
    });
  })
  .then((result) => {
    statusMessage.textContent = "Script completed.";
    // Process each tag and call showOptionsOnHover
    promptElements.forEach((tag) => {
      showOptionsOnHover(tag, optionsCount);
    });
  })
  .catch((error) => {
    console.error("Error:", error);
    statusMessage.textContent = "Script encountered an error.";
  })
});

// button handling automatically via evenlisteners
function handleButtonToggle(button) {
  var cell = button.parentNode.nextElementSibling;
  var state = cell.getAttribute("data-state");

  if (state === "locked") {
    cell.setAttribute("data-state", "unlocked");
    button.textContent = '❌';
    button.classList.remove("locked");
    button.classList.add("unlocked");
    console.log("State changed to unlocked");
  } else {
    cell.setAttribute("data-state", "locked");
    button.textContent = '✅';
    button.classList.remove("unlocked");
    button.classList.add("locked");
    console.log("State changed to locked");
  }
}



//Handles button colors automatically via eventlistener
  function handleButtonWait(buttonId) {
  var button = document.getElementById(buttonId);
  var originalColor = button.classList.contains("default-gray")
    ? "default-gray"
    : "dark-gray";

  button.classList.add("white");
  button.disabled = true;

  setTimeout(function () {
    button.classList.remove("white");
    button.disabled = false;
    button.classList.add(originalColor);
  }, 3000);
  }



</script>

